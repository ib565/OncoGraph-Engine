template_id: f6_1_resistance_genes_for_union_therapies_in_disease
family_id: F6.1
question: "Which genes predict resistance to {{ therapy_name_a }} or {{ therapy_name_b }} in {{ disease_name }}?"
cypher: |
  MATCH (b:Biomarker)-[rel:AFFECTS_RESPONSE_TO]->(t:Therapy)
  WHERE (
    toLower(t.name) = toLower('{{ therapy_name_a }}')
    OR toLower(t.name) = toLower('{{ therapy_name_b }}')
    OR any(s IN coalesce(t.synonyms, []) WHERE toLower(s) = toLower('{{ therapy_name_a }}'))
    OR any(s IN coalesce(t.synonyms, []) WHERE toLower(s) = toLower('{{ therapy_name_b }}'))
    OR toLower(t.name) CONTAINS toLower('{{ therapy_name_a }}')
    OR toLower(t.name) CONTAINS toLower('{{ therapy_name_b }}')
  )
  AND toLower(rel.effect) = 'resistance'
  {{ disease_filter }}
  OPTIONAL MATCH (b)-[:VARIANT_OF]->(g:Gene)
  WITH
    CASE WHEN b:Gene THEN b.symbol ELSE g.symbol END AS gene_symbol,
    t.name AS therapy_name,
    rel.disease_name AS disease_name,
    coalesce(rel.pmids, []) AS pmids
  WHERE gene_symbol IS NOT NULL
  UNWIND pmids AS p
  WITH gene_symbol, therapy_name, disease_name, collect(DISTINCT p) AS pmids
  RETURN
    NULL AS variant_name,
    gene_symbol,
    therapy_name,
    'resistance' AS effect,
    disease_name,
    pmids
  LIMIT 100
placeholders:
  therapy_name_a:
    from: civic.therapies
    sample: canonical_only
  therapy_name_b:
    from: civic.therapies
    sample: canonical_only
  disease_name:
    from: civic.diseases
    sample: canonical_only


